"use client"

import { useState } from "react"
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  SafeAreaView,
  Alert,
  ActivityIndicator,
  ScrollView,
} from "react-native"
import { styles } from "../styles/styles"
import UserService from "../services/userService"
import WorkerService from "../services/workerService"
import { users } from "../data/mockData" // Fallback data

const RegisterScreen = ({ onRegister, onBackToLogin }) => {
  const [formData, setFormData] = useState({
    name: "",
    phone: "",
    email: "",
    password: "",
    confirmPassword: "",
    role: "customer", // default role
    specialty: "", // for workers
    area: "",
    certificate: "", // for workers
  })
  const [loading, setLoading] = useState(false)
  const [showWorkerFields, setShowWorkerFields] = useState(false)

  const validateForm = () => {
    const { name, phone, email, password, confirmPassword, role, specialty, area } = formData

    if (!name.trim()) {
      Alert.alert("L·ªói", "Vui l√≤ng nh·∫≠p h·ªç t√™n")
      return false
    }

    if (!phone.trim()) {
      Alert.alert("L·ªói", "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i")
      return false
    }

    if (phone.length < 10) {
      Alert.alert("L·ªói", "S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ √≠t nh·∫•t 10 s·ªë")
      return false
    }

    if (!email.trim()) {
      Alert.alert("L·ªói", "Vui l√≤ng nh·∫≠p email")
      return false
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(email)) {
      Alert.alert("L·ªói", "Email kh√¥ng h·ª£p l·ªá")
      return false
    }

    if (!password.trim()) {
      Alert.alert("L·ªói", "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u")
      return false
    }

    if (password.length < 6) {
      Alert.alert("L·ªói", "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±")
      return false
    }

    if (password !== confirmPassword) {
      Alert.alert("L·ªói", "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp")
      return false
    }

    if (!area.trim()) {
      Alert.alert("L·ªói", "Vui l√≤ng nh·∫≠p khu v·ª±c")
      return false
    }

    if (role === "worker" && !specialty.trim()) {
      Alert.alert("L·ªói", "Vui l√≤ng nh·∫≠p chuy√™n m√¥n")
      return false
    }

    return true
  }

  const checkPhoneExists = async (phone) => {
    try {
      // Check in Firebase first
      const existingUsers = await UserService.getAllUsers()
      const phoneExists = existingUsers.some((user) => user.phone === phone)

      if (phoneExists) return true

      // Check in mock data as fallback
      const mockUser = users.find((user) => user.phone === phone)
      return !!mockUser
    } catch (error) {
      console.error("Error checking phone:", error)
      // Check in mock data as fallback
      const mockUser = users.find((user) => user.phone === phone)
      return !!mockUser
    }
  }

  const handleRegister = async () => {
    if (!validateForm()) return

    try {
      setLoading(true)

      // Check if phone already exists
      const phoneExists = await checkPhoneExists(formData.phone)
      if (phoneExists) {
        Alert.alert("L·ªói", "S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng")
        return
      }

      // 1. T·∫°o user c∆° b·∫£n trong b·∫£ng users
      const basicUserData = {
        name: formData.name.trim(),
        phone: formData.phone.trim(),
        email: formData.email.trim().toLowerCase(),
        password: formData.password,
        role: formData.role,
        area: formData.area.trim(),
        status: "active", // User c∆° b·∫£n lu√¥n active
        joinDate: new Date().toISOString().split("T")[0],
      }

      let userId = null
      try {
        userId = await UserService.createUser(basicUserData)
        console.log("‚úÖ User created successfully in users table:", userId)
      } catch (error) {
        console.error("‚ùå Error creating user:", error)
        throw new Error("Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n c∆° b·∫£n")
      }

      // 2. N·∫øu l√† worker, t·∫°o th√™m b·∫£n ghi trong b·∫£ng workers
      if (formData.role === "worker" && userId) {
        const workerData = {
          userId: userId, // Li√™n k·∫øt v·ªõi user
          name: formData.name.trim(),
          phone: formData.phone.trim(),
          email: formData.email.trim().toLowerCase(),
          specialty: formData.specialty.trim(),
          certificate: formData.certificate.trim(),
          area: formData.area.trim(),
          status: "pending", // Worker c·∫ßn admin duy·ªát
          rating: 0,
          completedOrders: 0,
          experience: "M·ªõi b·∫Øt ƒë·∫ßu",
          price: "100,000ƒë/gi·ªù", // Default price
          avatar: "üë®‚Äçüîß",
          reviews: 0,
          joinDate: new Date().toISOString().split("T")[0],
        }

        try {
          const workerId = await WorkerService.createWorker(workerData)
          console.log("‚úÖ Worker profile created successfully:", workerId)
        } catch (error) {
          console.error("‚ùå Error creating worker profile:", error)
          // N·∫øu t·∫°o worker th·∫•t b·∫°i, c√≥ th·ªÉ x√≥a user ƒë√£ t·∫°o ho·∫∑c ƒë·ªÉ user t·ªìn t·∫°i
          console.warn("‚ö†Ô∏è User created but worker profile failed")
        }
      }

      // Show success message
      Alert.alert(
        "ƒêƒÉng k√Ω th√†nh c√¥ng! üéâ",
        formData.role === "worker"
          ? "T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o. H·ªì s∆° th·ª£ ƒëang ch·ªù admin duy·ªát. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi ƒë∆∞·ª£c k√≠ch ho·∫°t."
          : "B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ngay b√¢y gi·ªù!",
        [
          {
            text: "ƒêƒÉng nh·∫≠p ngay",
            onPress: () => {
              onRegister()
            },
          },
        ],
      )
    } catch (error) {
      console.error("Registration error:", error)
      Alert.alert("L·ªói", error.message || "ƒê√£ x·∫£y ra l·ªói khi ƒëƒÉng k√Ω. Vui l√≤ng th·ª≠ l·∫°i.")
    } finally {
      setLoading(false)
    }
  }

  const handleInputChange = (field, value) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }))
  }

  const handleRoleChange = (role) => {
    setFormData((prev) => ({
      ...prev,
      role: role,
      specialty: "",
      certificate: "",
    }))
    setShowWorkerFields(role === "worker")
  }

  const registerContentStyle = {
    flexGrow: 1,
    padding: 20,
    justifyContent: "flex-start",
  }

  return (
    <SafeAreaView style={styles.container}>
      <ScrollView contentContainerStyle={registerContentStyle} showsVerticalScrollIndicator={false}>
        <View style={styles.header}>
          <Text style={styles.logo}>üìù</Text>
          <Text style={styles.title}>ƒêƒÉng k√Ω t√†i kho·∫£n</Text>
          <Text style={styles.subtitle}>T·∫°o t√†i kho·∫£n m·ªõi ƒë·ªÉ s·ª≠ d·ª•ng d·ªãch v·ª•</Text>
        </View>

        <View style={styles.form}>
          {/* Role Selection */}
          <View style={styles.roleContainer}>
            <Text style={styles.roleLabel}>Lo·∫°i t√†i kho·∫£n:</Text>
            <View style={styles.roleButtons}>
              <TouchableOpacity
                style={[styles.roleButton, formData.role === "customer" && styles.activeRoleButton]}
                onPress={() => handleRoleChange("customer")}
                disabled={loading}
              >
                <Text style={[styles.roleButtonText, formData.role === "customer" && styles.activeRoleButtonText]}>
                  üë§ Kh√°ch h√†ng
                </Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={[styles.roleButton, formData.role === "worker" && styles.activeRoleButton]}
                onPress={() => handleRoleChange("worker")}
                disabled={loading}
              >
                <Text style={[styles.roleButtonText, formData.role === "worker" && styles.activeRoleButtonText]}>
                  üë®‚Äçüîß Th·ª£ s·ª≠a ch·ªØa
                </Text>
              </TouchableOpacity>
            </View>
          </View>

          {/* Basic Information */}
          <TextInput
            style={styles.input}
            placeholder="H·ªç v√† t√™n *"
            value={formData.name}
            onChangeText={(value) => handleInputChange("name", value)}
            editable={!loading}
          />

          <TextInput
            style={styles.input}
            placeholder="S·ªë ƒëi·ªán tho·∫°i *"
            value={formData.phone}
            onChangeText={(value) => handleInputChange("phone", value)}
            keyboardType="phone-pad"
            editable={!loading}
          />

          <TextInput
            style={styles.input}
            placeholder="Email *"
            value={formData.email}
            onChangeText={(value) => handleInputChange("email", value)}
            keyboardType="email-address"
            autoCapitalize="none"
            editable={!loading}
          />

          <TextInput
            style={styles.input}
            placeholder="Khu v·ª±c (VD: Qu·∫≠n 1, TP.HCM) *"
            value={formData.area}
            onChangeText={(value) => handleInputChange("area", value)}
            editable={!loading}
          />

          <TextInput
            style={styles.input}
            placeholder="M·∫≠t kh·∫©u (√≠t nh·∫•t 6 k√Ω t·ª±) *"
            value={formData.password}
            onChangeText={(value) => handleInputChange("password", value)}
            secureTextEntry
            editable={!loading}
          />

          <TextInput
            style={styles.input}
            placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u *"
            value={formData.confirmPassword}
            onChangeText={(value) => handleInputChange("confirmPassword", value)}
            secureTextEntry
            editable={!loading}
          />

          {/* Worker-specific fields */}
          {showWorkerFields && (
            <>
              <View style={styles.workerFieldsContainer}>
                <Text style={styles.workerFieldsTitle}>Th√¥ng tin th·ª£ s·ª≠a ch·ªØa</Text>

                <TextInput
                  style={styles.input}
                  placeholder="Chuy√™n m√¥n (VD: Th·ª£ ƒëi·ªán, Th·ª£ n∆∞·ªõc) *"
                  value={formData.specialty}
                  onChangeText={(value) => handleInputChange("specialty", value)}
                  editable={!loading}
                />

                <TextInput
                  style={styles.input}
                  placeholder="Ch·ª©ng ch·ªâ (n·∫øu c√≥)"
                  value={formData.certificate}
                  onChangeText={(value) => handleInputChange("certificate", value)}
                  editable={!loading}
                />

                <View style={styles.workerNote}>
                  <Text style={styles.workerNoteText}>
                    üìù L∆∞u √Ω: H·ªì s∆° th·ª£ s·∫Ω ƒë∆∞·ª£c l∆∞u ri√™ng v√† c·∫ßn admin duy·ªát tr∆∞·ªõc khi c√≥ th·ªÉ nh·∫≠n ƒë∆°n h√†ng.
                  </Text>
                </View>
              </View>
            </>
          )}

          <TouchableOpacity
            style={[styles.loginButton, loading && { opacity: 0.7 }]}
            onPress={handleRegister}
            disabled={loading}
          >
            {loading ? <ActivityIndicator color="white" /> : <Text style={styles.loginButtonText}>ƒêƒÉng k√Ω</Text>}
          </TouchableOpacity>

          <TouchableOpacity style={styles.registerButton} onPress={onBackToLogin} disabled={loading}>
            <Text style={styles.registerButtonText}>ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    </SafeAreaView>
  )
}

export default RegisterScreen
